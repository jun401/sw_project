<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ğŸ¥— ì›”ê°„ ì‹ë‹¨ í”Œë˜ë„ˆ</title>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #f6faf7;
      text-align: center;
      margin: 0;
    }
    h1 {
      font-size: 36px;
      color: #2e7d32;
      margin-top: 30px;
      font-weight: 700;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      grid-auto-rows: minmax(150px, auto);
      gap: 10px;
      width: 90%;
      margin: 30px auto;
    }
    .day {
      background: white;
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: 0.2s;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: flex-start;
      text-align: left;
    }
    .day:hover {
      background: #e8f5e9;
      transform: scale(1.02);
    }
    .header {
      font-weight: 700;
      font-size: 15px;
      margin-bottom: 6px;
      color: #2e7d32;
    }
    .meal {
      font-size: 13px;
      color: #333;
      margin: 3px 0;
      white-space: pre-wrap;
    }
    .empty {
      color: #aaa;
      font-size: 12px;
    }
    .nav-btn {
      background: #4caf50;
      border: none;
      color: white;
      border-radius: 8px;
      padding: 8px 15px;
      margin: 10px;
      font-weight: bold;
      cursor: pointer;
    }
    .nav-btn:hover {
      background: #43a047;
    }
    #recommend-section {
      background: #ffffff;
      width: 85%;
      margin: 40px auto;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 20px;
    }
    #recommend-section h2 {
      color: #388e3c;
      font-size: 22px;
      margin-bottom: 15px;
    }
    .recommend-list {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
    }
    .recommend-item {
      background: #f1f8e9;
      border-radius: 8px;
      padding: 10px 15px;
      font-size: 14px;
      color: #2e7d32;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

  <h1>ğŸ¥— ì›”ê°„ ì‹ë‹¨ í”Œë˜ë„ˆ</h1>
  <div>
    <button id="prevMonth" class="nav-btn">â—€ ì´ì „ ë‹¬</button>
    <span id="monthLabel" style="font-size:18px; font-weight:bold;"></span>
    <button id="nextMonth" class="nav-btn">ë‹¤ìŒ ë‹¬ â–¶</button>
  </div>

  <div class="calendar" id="calendar"></div>

  <div id="recommend-section">
    <h2>ğŸ± ì˜¤ëŠ˜ì˜ ëœë¤ ì¶”ì²œ ë©”ë‰´</h2>
    <div id="recommendList" class="recommend-list">
      <p>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
  </div>

  <script>
    const calendar = document.getElementById("calendar");
    let today = new Date();
    let currentDate = new Date(today.getFullYear(), today.getMonth(), 1);

    function formatDate(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function renderCalendar() {
      calendar.innerHTML = "";

      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDay = firstDay.getDay();
      const totalDays = lastDay.getDate();

      document.getElementById("monthLabel").textContent = `${year}ë…„ ${month + 1}ì›”`;

      const days = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];

      for (let i = 0; i < startDay; i++) {
        const blank = document.createElement("div");
        blank.className = "day";
        blank.style.visibility = "hidden";
        calendar.appendChild(blank);
      }

      for (let d = 1; d <= totalDays; d++) {
        const date = new Date(year, month, d);
        const cell = document.createElement("div");
        cell.className = "day";

        cell.innerHTML = `
          <div class="header">${days[date.getDay()]}<br>${d}ì¼</div>
          <div id="meals-${d}" class="meal empty">ì €ì¥ëœ ì‹ë‹¨ ì—†ìŒ</div>
        `;

        cell.onclick = () => {
          const dStr = formatDate(date);
          window.open(
            `/recipe-popup?date=${dStr}`,
            "_blank",
            "width=480,height=640,scrollbars=yes,resizable=no"
          );
        };
        calendar.appendChild(cell);
      }

      fetch("/mealplans")
        .then(res => res.json())
        .then(plans => {
          plans.forEach(p => {
            const el = document.getElementById(`meals-${p.day}`);
            if (el) {
              if (el.classList.contains("empty")) el.textContent = "";
              el.classList.remove("empty");
              el.innerHTML += `<div>ğŸ½ï¸ ${p.mealType}: ${p.recipeName}</div>`;
            }
          });
        })
        .catch(err => console.error("âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", err));
    }

    document.getElementById("prevMonth").onclick = () => {
      currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
      renderCalendar();
    };
    document.getElementById("nextMonth").onclick = () => {
      currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
      renderCalendar();
    };

    renderCalendar();

    /* ------------------------------------------------
      ğŸŸ© AI ê¸°ë°˜ ë©”ë‰´ ì¶”ì²œ - ì„œë²„ /ai-recommend ì‚¬ìš©
    --------------------------------------------------*/
    async function loadAiMenus() {
      const recommendList = document.getElementById("recommendList");
      recommendList.innerHTML = "<p>ì˜¤ëŠ˜ ë©”ë‰´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>";

      try {
        const res = await fetch("/ai-recommend");
        if (!res.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜: " + res.status);

        const menus = await res.json();

        recommendList.innerHTML = menus
          .map(m => `<div class="recommend-item">${m}</div>`)
          .join("");

      } catch (error) {
        console.error("AI ì¶”ì²œ ì‹¤íŒ¨:", error);

        const fallbackMenus = ["ë¹„ë¹”ë°¥", "ëœì¥ì°Œê°œ", "ë‹­ê°€ìŠ´ì‚´ ìƒëŸ¬ë“œ", "ê¹€ì¹˜ë³¶ìŒë°¥", "ë¶ˆê³ ê¸°"];
        recommendList.innerHTML = fallbackMenus
          .map(r => `<div class="recommend-item">${r}</div>`)
          .join("");
      }
    }

    loadAiMenus();
    setInterval(loadAiMenus, 10000);  // 10ì´ˆë§ˆë‹¤ ìƒˆë¡œ ì¶”ì²œ

  </script>
</body>
</html>
